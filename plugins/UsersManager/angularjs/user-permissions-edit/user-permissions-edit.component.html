<div class="userPermissionsEdit" ng-class="{ loading: $ctrl.isLoadingAccess }">
    <div class="row">
        <div class="input-field bulk-actions">
            <a
                class='dropdown-trigger btn'
                href=''
                data-activates='user-permissions-edit-bulk-actions'
                piwik-dropdown-menu
                ng-class="{ disabled: $ctrl.isBulkActionsDisabled }"
            >
                Bulk Actions
            </a>
            <ul id='user-permissions-edit-bulk-actions' class='dropdown-content'>
                <li>
                    <a class='dropdown-trigger' data-activates="bulk-set-access" piwik-dropdown-menu>Set Access</a>
                    <ul id="bulk-set-access" class="dropdown-content">
                        <li ng-repeat="access in $ctrl.accessLevels">
                            <a href="" ng-click="$ctrl.siteAccessToChange = null; $ctrl.roleToChangeTo = access.key; $ctrl.showChangeAccessConfirm();">{{ access.value }}</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="" ng-click="$ctrl.siteAccessToChange = null; $ctrl.roleToChangeTo = 'noaccess'; $ctrl.showRemoveAccessConfirm();">Remove Access</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="filters row">
        <div class=" col s12 m6">
            <div class="input-field site-filter">
                <input type="text" placeholder="Site search" ng-model="$ctrl.siteNameFilter" ng-change="$ctrl.fetchAccess()" />
            </div>

            <div class="input-field access-filter">
                <div
                    piwik-field
                    uicontrol="select"
                    ng-model="$ctrl.accessLevelFilter"
                    options="$ctrl.accessLevelFilterOptions"
                    full-width="true"
                    ng-change="$ctrl.fetchAccess()"
                ></div>
            </div>
        </div>
        <div class="col m6">
            <div class="input-field add-site">
                <!-- TODO: site selector must support filters on site so we can ignore those in table -->
                <div
                    piwik-field
                    class="add-site-selector"
                    uicontrol="site"
                    ng-model="$ctrl.siteToAdd"
                    ui-control-attributes="{showAllSitesItem: true}"
                ></div>
                <a class='btn' ng-click="$ctrl.roleToChangeTo = 'view'; $ctrl.siteAccessToChange = { idsite: $ctrl.siteToAdd.id }; $ctrl.addUserRole()">Add Access</a>
            </div>
        </div>
    </div>

    <table piwik-content-table id="sitesForPermission">
        <thead>
        <tr>
            <th class="select-cell">
                <span class="checkbox-container">
                    <input type="checkbox" id="select_all" ng-model="$ctrl.isAllCheckboxSelected" ng-change="$ctrl.onAllCheckboxChange()" />
                    <label for="select_all"></label>
                </span>
            </th>
            <th>Name</th>
            <th>Role</th>
            <th class="actions-cell">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr class="select-all-row" ng-if="$ctrl.isAllCheckboxSelected">
            <td colspan="4">
                <div ng-if="!$ctrl.areAllResultsSelected">
                    The <strong>{{ $ctrl.siteAccess.length }}</strong> displayed websites are selected.
                    <a href="#" ng-click="$ctrl.areAllResultsSelected = !$ctrl.areAllResultsSelected">Click to select all <strong>{{ $ctrl.totalEntries }}</strong>.</a>
                </div>

                <div ng-if="$ctrl.areAllResultsSelected">
                    All <strong>{{ $ctrl.totalEntries }}</strong> websites are selected.
                    <a href="#" ng-click="$ctrl.areAllResultsSelected = !$ctrl.areAllResultsSelected">Click to select the <strong>{{ $ctrl.siteAccess.length }}</strong> displayed websites.</a>
                </div>
            </td>
        </tr>
        <tr ng-repeat="entry in $ctrl.siteAccess">
            <td class="select-cell">
                <span class="checkbox-container">
                    <input type="checkbox" ng-attr-id="select_row{{ $index }}" ng-model="$ctrl.selectedRows[$index]" ng-click="$ctrl.onRowSelected()" />
                    <label ng-attr-for="select_row{{ $index }}"></label>
                </span>
            </td>
            <td>
                <span>{{ entry.site_name }}</span>
            </td>
            <td>
                <div
                    piwik-field
                    uicontrol="select"
                    ng-model="entry.role"
                    options="$ctrl.accessLevels"
                    ng-change="$ctrl.previousRole = '{{ entry.role }}'; $ctrl.roleToChangeTo = entry.role; $ctrl.siteAccessToChange = entry; $ctrl.showChangeAccessConfirm();"
                ></div>
            </td>
            <td class="center actions-cell">
                <button
                    class="deleteaccess table-action"
                    title="Remove all access to this website"
                    ng-click="$ctrl.roleToChangeTo = 'noaccess'; $ctrl.siteAccessToChange = entry; $ctrl.showRemoveAccessConfirm();"
                >
                    <span class="icon-delete"></span>
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="row" ng-if="$ctrl.totalEntries > $ctrl.limit">
        <div class="input-field col sites-for-permission-pagination s12">
            <a class="prev" disabled="disabled">
                <span class="pointer" ng-click="$ctrl.gotoPreviousPage()">« Previous</span>
            </a>

            <span class="counter">
                <span>
                    {{ $ctrl.offset }} - {{ $ctrl.getPaginationUpperBound() }} of {{ $ctrl.totalEntries }}
                </span>
            </span>

            <a class="next">
                <span class="pointer" ng-click="$ctrl.gotoNextPage()">Next »</span>
            </a>
        </div>
    </div>

    <div class="delete-access-confirm-modal modal">
        <div class="modal-content">
            <h3 ng-if="$ctrl.siteAccessToChange">Are you sure you want to remove <strong>{{ $ctrl.userLogin }}</strong>'s access to <strong>{{ $ctrl.siteAccessToChange.site_name }}</strong>?</h3>
            <p ng-if="!$ctrl.siteAccessToChange">Are you sure you want to remove <strong>{{ $ctrl.userLogin }}</strong>'s access the <strong>{{ $ctrl.getAffectedSitesCount() }}</strong> selected websites?</p>
        </div>
        <div class="modal-footer">
            <a href="" class="modal-action modal-close btn" ng-click="$ctrl.changeUserRole()">Yes</a>
            <a href="" class="modal-action modal-close modal-no" ng-click="$ctrl.siteAccessToChange = null; $ctrl.roleToChangeTo = null;">No</a>
        </div>
    </div>

    <div class="change-access-confirm-modal modal">
        <div class="modal-content">
            <h3 ng-if="$ctrl.siteAccessToChange">Are you sure you want to change <strong>{{ $ctrl.userLogin }}</strong>'s access to <strong>{{ $ctrl.siteAccessToChange.site_name }}</strong> to <strong>{{ $ctrl.getRoleDisplay($ctrl.roleToChangeTo) }}</strong>?</h3>
            <p ng-if="!$ctrl.siteAccessToChange">Are you sure you want to remove <strong>{{ $ctrl.userLogin }}</strong>'s access the <strong>{{ $ctrl.getAffectedSitesCount() }}</strong> selected websites to <strong>{{ $ctrl.getRoleDisplay($ctrl.roleToChangeTo) }}</strong>?</p>
        </div>
        <div class="modal-footer">
            <a href="" class="modal-action modal-close btn" ng-click="$ctrl.changeUserRole()">Yes</a>
            <a href="" class="modal-action modal-close modal-no" ng-click="$ctrl.siteAccessToChange.role = $ctrl.previousRole; $ctrl.siteAccessToChange = null; $ctrl.roleToChangeTo = null;">No</a>
        </div>
    </div>
</div>