<div class="pagedUsersList" ng-class="{loading: $ctrl.isLoadingUsers}">
    <div class="userListFilters row">
        <div class="input-field col s12 m2">
            <a
                class='dropdown-trigger btn'
                href=''
                data-activates='user-list-bulk-actions'
                piwik-dropdown-menu
                ng-class="{ disabled: $ctrl.isBulkActionsDisabled }"
            >
                Bulk Actions
            </a>
            <ul id='user-list-bulk-actions' class='dropdown-content'>
                <li>
                    <a
                        class='dropdown-trigger'
                        data-activates="bulk-set-access"
                        piwik-dropdown-menu
                    >
                        Set Access
                    </a>
                    <ul id="bulk-set-access" class="dropdown-content">
                        <li ng-repeat="access in $ctrl.bulkActionAccessLevels">
                            <a
                                href=""
                                ng-click="$ctrl.userToChange = null; $ctrl.roleToChangeTo = access.key; $ctrl.showAccessChangeConfirm();"
                            >
                                {{ access.value }}
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a
                        href=""
                        ng-click="$ctrl.userToChange = null; $ctrl.roleToChangeTo = 'noaccess'; $ctrl.showAccessChangeConfirm();"
                    >
                        Remove Access
                    </a>
                </li>
                <li ng-if="$ctrl.currentUserRole == 'superuser'">
                    <a href="" ng-click="$ctrl.showDeleteConfirm()">Delete Users</a>
                </li>
            </ul>
        </div>
        <div class="input-field col s12 m2">
            <div
                piwik-field
                class="permissions-for-selector"
                uicontrol="text"
                ng-model="$ctrl.userTextFilter"
                ng-model-options="{debounce: 300}"
                placeholder="User search"
                full-width="true"
                ng-change="$ctrl.offset = 0; $ctrl.fetchUsers()"
            ></div>
        </div>
        <div class="input-field col s12 m2">
            <div
                piwik-field
                uicontrol="select"
                ng-model="$ctrl.accessLevelFilter"
                placeholder="Filter by access"
                options="$ctrl.accessLevelFilterOptions"
                full-width="true"
                ng-change="$ctrl.offset = 0; $ctrl.fetchUsers()"
            ></div>
        </div>
        <div class="input-field col s12 m6" ng-if="$ctrl.totalEntries > $ctrl.limit">
            <div class="usersListPagination">
                <a class="btn prev" ng-class="{ disabled: $ctrl.offset <= 0 }" ng-click="$ctrl.gotoPreviousPage()">
                    <span class="pointer">« Previous</span>
                </a>

                <div class="counter">
                    <span>
                            {{ $ctrl.offset }} - {{ $ctrl.getPaginationUpperBound() }} of {{ $ctrl.totalEntries }}
                    </span>
                    <div piwik-activity-indicator ng-if="$ctrl.isLoadingUsers" loading="$ctrl.isLoadingUsers"></div>
                </div>

                <a class="btn next" ng-class="{ disabled: $ctrl.offset + $ctrl.limit >= $ctrl.totalEntries }" ng-click="$ctrl.gotoNextPage()">
                    <span class="pointer">Next »</span>
                </a>
            </div>
        </div>
    </div>

    <div piwik-notification context="info" type="persistent" noclear="true" ng-if="$ctrl.isRoleHelpToggled" class="roles-help-notification">
        Roles determine what a user can do in Matomo with regard to a specific website. Learn more about the <a href='https://matomo.org/faq/general/faq_70/' target='_blank' rel='noreferrer noopener'>View</a> and <a href='https://matomo.org/faq/general/faq_69/' target='_blank' rel='noreferrer noopener'>Admin</a> roles.
    </div>

    <div piwik-content-block>
        <table piwik-content-table id="manageUsersTable" ng-class="{ loading: $ctrl.isLoadingUsers }">
            <thead>
            <tr>
                <th class="select-cell">
                    <span class="checkbox-container">
                        <input type="checkbox" id="select_all" checked="checked" ng-model="$ctrl.isAllCheckboxSelected" ng-change="$ctrl.onAllCheckboxChange()" />
                        <label for="select_all"></label>
                    </span>
                </th>
                <th class='first'>Username</th>
                <th class="role_header">
                    <span>Role for</span>
                    <a href="" class="helpIcon" ng-click="$ctrl.isRoleHelpToggled = !$ctrl.isRoleHelpToggled" ng-class="{ sticky: $ctrl.isRoleHelpToggled }">
                        <span class="icon-help"></span>
                    </a>

                    <div
                        piwik-field
                        class="permissions-for-selector"
                        uicontrol="site"
                        ng-model="$ctrl.permissionsForSite"
                        ng-change="$ctrl.fetchUsers()"
                        ui-control-attributes="{ onlySitesWithAdminAccess: $ctrl.currentUserRole !== 'superuser' }"
                    ></div>
                </th>
                <th ng-if="$ctrl.currentUserRole == 'superuser'">Email</th>
                <th ng-if="$ctrl.currentUserRole == 'superuser'">Last Seen</th>
                <th class="actions-cell-header"><div>Actions</div></th> <!-- TODO: translate -->
            </tr>
            </thead>

            <tbody>
                <tr class="select-all-row" ng-if="$ctrl.isAllCheckboxSelected && $ctrl.users.length && $ctrl.users.length < $ctrl.totalEntries">
                    <td colspan="7">
                        <div ng-if="!$ctrl.areAllResultsSelected">
                            The <strong>{{$ctrl.offset = 0;  $ctrl.users.length }}</strong> displayed users are selected.
                            <a href="#" ng-click="$ctrl.areAllResultsSelected = !$ctrl.areAllResultsSelected">Click to select all <strong>{{ $ctrl.totalEntries }}</strong>.</a>
                        </div>

                        <div ng-if="$ctrl.areAllResultsSelected">
                            All <strong>{{ $ctrl.totalEntries }}</strong> users are selected.
                            <a href="#" ng-click="$ctrl.areAllResultsSelected = !$ctrl.areAllResultsSelected">Click to select the <strong>{{ $ctrl.users.length }}</strong> displayed users.</a>
                        </div>
                    </td>
                </tr>

                <tr ng-repeat="user in $ctrl.users" ng-attr-id="row{{ $index }}">
                    <td class="select-cell">
                        <span class="checkbox-container">
                            <input type="checkbox" ng-attr-id="select_row{{:: $index }}" checked="checked" ng-model="$ctrl.selectedRows[$index]" ng-click="$ctrl.onRowSelected()" />
                            <label ng-attr-for="select_row{{:: $index }}"></label>
                        </span>
                    </td>
                    <td id="userLogin">{{:: user.login }}</td>
                    <td class="access-cell">
                        <div
                            piwik-field
                            uicontrol="select"
                            ng-model="user.role"
                            options="$ctrl.accessLevels"
                            ng-change="$ctrl.userToChange = user; $ctrl.roleToChangeTo = user.role; $ctrl.previousRole = '{{ user.role }}'; $ctrl.showAccessChangeConfirm();"
                            disabled="user.role == 'superuser'"
                        ></div>
                    </td>
                    <td id="email" ng-if="$ctrl.currentUserRole == 'superuser'">{{:: user.email }}</td>
                    <td id="last_seen" ng-if="$ctrl.currentUserRole == 'superuser'">
                        {{:: user.last_seen ? (user.last_seen + ' ago') : '-' }}
                    </td>
                    <td class="center actions-cell">
                        <button class="edituser table-action" title="Edit" ng-click="$ctrl.onEditUser({ user: user })">
                            <span class="icon-edit"></span>
                        </button>
                        <button class="deleteuser table-action" title="Delete" ng-click="$ctrl.userToChange = user; $ctrl.showDeleteConfirm()" ng-if="$ctrl.currentUserRole == 'superuser'">
                            <span class="icon-delete"></span>
                        </button>
                    </td>
                </tr>

            </tbody>
        </table>
    </div>

    <div class="delete-user-confirm-modal modal">
        <div class="modal-content">
            <h3 ng-if="$ctrl.userToChange">Are you sure you want to delete <strong>{{ $ctrl.userToChange.login }}</strong>?</h3>
            <p ng-if="!$ctrl.userToChange">Are you sure you want to delete the <strong>{{ $ctrl.getAffectedUsersCount() }}</strong> selected users?</p>
        </div>
        <div class="modal-footer">
            <a href="" class="modal-action modal-close btn" ng-click="$ctrl.deleteRequestedUsers()">Yes</a>
            <a href="" class="modal-action modal-close modal-no" ng-click="$ctrl.userToChange = null; $ctrl.roleToChangeTo = null;">No</a>
        </div>
    </div>

    <div class="change-user-role-confirm-modal modal">
        <div class="modal-content">
            <h3 ng-if="$ctrl.userToChange">Are you sure you want to change <strong>{{ $ctrl.userToChange.login }}</strong>'s role to <strong>{{ $ctrl.getRoleDisplay($ctrl.roleToChangeTo) }}</strong> for <strong>{{ $ctrl.permissionsForSite.name }}</strong>?</h3>
            <p ng-if="!$ctrl.userToChange">Are you sure you want to change the <strong>{{ $ctrl.getAffectedUsersCount() }}</strong> selected users' role to <strong>{{ $ctrl.getRoleDisplay($ctrl.roleToChangeTo) }}</strong> form <strong>{{ $ctrl.permissionsForSite.name }}</strong>?</p>
        </div>
        <div class="modal-footer">
            <a href="" class="modal-action modal-close btn" ng-click="$ctrl.changeUserRole()">Yes</a>
            <a href="" class="modal-action modal-close modal-no" ng-click="$ctrl.userToChange.role = $ctrl.previousRole; $ctrl.userToChange = null; $ctrl.roleToChangeTo = null;">No</a>
        </div>
    </div>
</div>