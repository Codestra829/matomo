{% set lastSeenComparePeriod = false %}
{% set comparedSegmentPretty = dataTable.getFirstRow().getMetadata('compareSegmentPretty') %}
{% set comparedPeriodPretty = dataTable.getFirstRow().getMetadata('comparePeriodPretty') %}
{%- for rowId, row in dataTable.getRows() -%}
    {% set isComparingSegments = comparisonSegmentIndices|length > 1 %}
    {% set isComparingPeriods = comparePeriodIndices|length > 1 or comparePeriodIndices|first|length > 1 %}

    {% set comparePeriod = row.getMetadata('comparePeriodPretty') %}
    {% if lastSeenComparePeriod != comparePeriod and isComparingSegments and isComparingPeriods %}
    <tr class="comparePeriod">
        <td colspan="{{ properties.columns_to_display|length }}">
            {{ comparePeriod }}
        </td>
    </tr>
    {% endif %}
    {% set overrideParams = {} %}

    {% set compareSegmentIndex = comparisonSegmentIndices[row.getMetadata('compareSegment')|default('')] %}
    {% set comparePeriodIndex = comparePeriodIndices[row.getMetadata('comparePeriodOriginal')|default('')][row.getMetadata('compareDateOriginal')|default('')] %}

    {% if row.getMetadata('compareSegment')|default is not empty %}{% set overrideParams = overrideParams|merge({ segment: row.getMetadata('compareSegment'), compareSegments: '' }) %}{% endif %}
    {% if row.getMetadata('comparePeriod')|default is not empty %}{% set overrideParams = overrideParams|merge({ period: row.getMetadata('comparePeriodOriginal'), comparePeriods: '' }) %}{% endif %}
    {% if row.getMetadata('compareDate')|default is not empty %}{% set overrideParams = overrideParams|merge({ date: row.getMetadata('compareDateOriginal'), compareDates: '' }) %}{% endif %}
    {% set idSubtable = row.getMetadata('idsubdatatable_in_db') %}
    <tr
        {% if idSubtable != false %}data-idsubtable="{{ idSubtable|e('html_attr') }}"{% endif %}
        data-comparison-segment="{{ compareSegmentIndex }}"
        data-comparison-period="{{ comparePeriodIndex }}"
        class="comparisonRow"
        data-param-override="{{ overrideParams|json_encode|e('html_attr') }}" data-label="{{ comparedRow.getColumn('label')|e('html_attr') }}"
        {% if row.getMetadata('segment') is not false %}data-segment-filter="{{ row.getMetadata('segment')|e('html_attr') }}"{% endif %}
    >
        <td>
            {% if isComparingSegments %}
                {%- set comparisonLabel = row.getMetadata('compareSegmentPretty') -%}
            {% else %}
                {%- set comparisonLabel = comparePeriod -%}
            {% endif %}
            <span class="label">{{ comparisonLabel }}</span>
        </td>
        {% for column in properties.columns_to_display %}
        {% if column != 'label' %}
        {% set columnValue = row.getColumn(column) %}
        <td>
            {% set columnChange = row.getColumn(column ~ '_change')|default('+0%') %}
            {% set comparisonTotals = indexedComparisonTotals[row.getMetadata('compareSegment')|default('')][row.getMetadata('comparePeriodOriginal')|default('')][row.getMetadata('compareDateOriginal')|default('')]|default(null) %}
            {% set comparisonTooltipSuffix = 'General_ComparisonRatioTooltip'|translate(columnChange, comparedSegmentPretty, comparedPeriodPretty) %}

            {% include "@CoreVisualizations/_dataTableViz_htmlTable_ratio.twig" with {
                'changePercentage': columnChange,
                'totals': comparisonTotals,
                'label': comparedRow.getColumn('label'),
                'labelColumn': properties.columns_to_display|first,
                'changePercantage': columnChange,
                'forceZero': true,
                'tooltipSuffix': comparisonTooltipSuffix,
                'translations': properties.translations
            } %}
            <span class="value">{{ columnValue|number(2,0)|rawSafeDecoded }}</span>
        </td>
        {% endif %}
        {% endfor %}
    </tr>
    {% set lastSeenComparePeriod = comparePeriod %}
{%- endfor -%}
